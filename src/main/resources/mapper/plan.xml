<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.trip.domain.plan.mapper.PlanMapper">

    <resultMap id="planDto" type="planDto">
        <result column="id" property="planId"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <resultMap id="planDetailsDto" type="planDetailsDto">
<!--        // User-->
<!--        private String nickname;-->

<!--        // Plan-->
<!--        private String planTitle;-->
<!--        private Long totalCost;-->
<!--        private LocalDate startDate;-->
<!--        private LocalDate endDate;-->
<!--        private int headCount;-->
<!--        private Long hit;-->

<!--        // Theme-->
<!--        private String theme;-->
        <result column="title" property="planTitle"/>
        <result column="title" property="planTitle"/>
    </resultMap>

    <select id="findByName" parameterType="string">
        select id, name
        from theme
        where name = #{name}
    </select>

    <insert id="saveTheme" parameterType="Theme">
        insert into theme(name)
        values(#{name})
        <selectKey resultType="long" keyProperty="id" order="AFTER">
            select last_insert_id()
        </selectKey>
    </insert>

    <insert id="savePlan" parameterType="Plan">
        insert into plan(user_id, theme_id, title, total_cost, start_date, end_date, head_count)
        values(${writerId}, ${themeId}, #{title}, ${totalCost}, #{startDate}, #{endDate}, ${headCount})
        <selectKey resultType="long" keyProperty="id" order="AFTER">
            select last_insert_id()
        </selectKey>
    </insert>

    <insert id="savePlanDetails" parameterType="java.util.Map">
        insert into plan_details(`order`, cost, plan_id, spot_id, vehicle_id)
        values
        <foreach collection="list" item="detail" separator=",">
            (${detail.order}, ${detail.cost}, ${detail.planId}, ${detail.spotId}, ${detail.vehicleId})
        </foreach>
    </insert>

    <select id="findPlans" resultMap="planDto">
        select p.id, p.start_date, p.end_date, p.title, u.nickname, p.created_at
        from plan p join user u
        on p.user_id = u.id
    </select>

<!--    Plan, User, Theme inner join -->
    <select id="findPlanById" resultMap="planDetailsDto">

    </select>

<!--    <select id="findPlanDtoById" resultMap="planDetailsDto">-->

<!--    </select>-->

</mapper>