<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.trip.domain.plan.mapper.PlanMapper">

    <resultMap id="planDto" type="planDto">
        <result column="id" property="planId"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <resultMap id="planDetailsDto" type="planDetailsDto">
<!--        select u.nickname, p.title, p.total_cost, p.start_date, p.end_date, p.head_count, p.hit, th.name-->
        <result column="title" property="planTitle"/>
        <result column="total_cost" property="totalCost"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="head_count" property="headCount"/>
        <result column="name" property="theme"/>
    </resultMap>

    <resultMap id="detailsDto" type="detailsDto">
        <result column="name" property="vehicleName"/>
        <result column="title" property="spotTitle"/>
        <result column="image" property="spotImage"/>
    </resultMap>

    <select id="findByName" parameterType="string">
        select id, name
        from theme
        where name = #{name}
    </select>

    <insert id="saveTheme" parameterType="Theme">
        insert into theme(name)
        values(#{name})
        <selectKey resultType="long" keyProperty="id" order="AFTER">
            select last_insert_id()
        </selectKey>
    </insert>

    <insert id="savePlan" parameterType="Plan">
        insert into plan(user_id, theme_id, title, total_cost, start_date, end_date, head_count)
        values(${writerId}, ${themeId}, #{title}, ${totalCost}, #{startDate}, #{endDate}, ${headCount})
        <selectKey resultType="long" keyProperty="id" order="AFTER">
            select last_insert_id()
        </selectKey>
    </insert>

    <insert id="savePlanDetails" parameterType="java.util.Map">
        insert into plan_details(`order`, cost, plan_id, spot_id, vehicle_id)
        values
        <foreach collection="list" item="detail" separator=",">
            (${detail.order}, ${detail.cost}, ${detail.planId}, ${detail.spotId}, ${detail.vehicleId})
        </foreach>
    </insert>

    <update id="updateHit" parameterType="long">
        update plan
        set hit = hit + 1, updated_at = now()
        where id = ${id}
    </update>

    <update id="deleteById" parameterType="long">
        update plan
        set is_deleted = true, updated_at = now()
        where id = ${id}
    </update>

    <select id="findPlans" resultMap="planDto">
        select p.id, p.start_date, p.end_date, p.title, u.nickname, p.created_at
        from plan p join user u
        on p.user_id = u.id
        where is_deleted = false
    </select>

<!--    Plan, User, Theme inner join -->
    <select id="findPlanById" parameterType="long" resultMap="planDetailsDto">
        select u.nickname, p.title, p.total_cost, p.start_date, p.end_date, p.head_count, p.hit, th.name
        from plan p join user u join theme th
        on p.user_id = u.id and p.theme_id = th.id
        where p.id = ${id}
    </select>

    <select id="findPlanDetailsByPlanId" parameterType="long" resultMap="detailsDto">
        select v.name, s.title, s.image, pd.cost, pd.order
        from plan_details pd join vehicle v join spot s
        on pd.vehicle_id = v.id and pd.spot_id = s.id
        where pd.plan_id = ${planId}
    </select>

</mapper>